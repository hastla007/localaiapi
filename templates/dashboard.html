<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI API Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .gallery-item { transition: transform 0.2s; }
        .gallery-item:hover { transform: scale(1.05); }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preview-container {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">ü§ñ AI API Dashboard</h1>
                    <p class="text-blue-100 mt-1">Multi-Model AI Management Console</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center space-x-2">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
                        <span id="status-text" class="text-sm">Online</span>
                    </div>
                    <div id="gpu-name" class="text-xs text-blue-100 mt-1">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <div class="flex space-x-2 py-3 overflow-x-auto">
                <button onclick="showTab('overview')" class="tab-button active px-6 py-2 rounded-lg font-medium transition whitespace-nowrap">
                    üìä Overview
                </button>
                <button onclick="showTab('playground')" class="tab-button px-6 py-2 rounded-lg font-medium transition whitespace-nowrap">
                    üéÆ Playground
                </button>
                <button onclick="showTab('results')" class="tab-button px-6 py-2 rounded-lg font-medium transition whitespace-nowrap">
                    üñºÔ∏è Results
                </button>
                <button onclick="showTab('metrics')" class="tab-button px-6 py-2 rounded-lg font-medium transition whitespace-nowrap">
                    üìà Metrics
                </button>
                <button onclick="showTab('logs')" class="tab-button px-6 py-2 rounded-lg font-medium transition whitespace-nowrap">
                    üìù Logs
                </button>
                <button onclick="showTab('settings')" class="tab-button px-6 py-2 rounded-lg font-medium transition whitespace-nowrap">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <!-- System Status Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">System Status</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">API Status:</span>
                            <span id="api-status" class="font-semibold text-green-600">Online</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">GPU Available:</span>
                            <span id="gpu-status" class="font-semibold">Yes</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loaded Models:</span>
                            <span id="loaded-count" class="font-semibold">0</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Quick Actions</h3>
                    <div class="space-y-2">
                        <button onclick="unloadAllModels()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded transition">
                            üóëÔ∏è Unload All Models
                        </button>
                        <button onclick="refreshStatus()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition">
                            üîÑ Refresh Status
                        </button>
                        <button onclick="showTab('playground')" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded transition">
                            üéÆ Open Playground
                        </button>
                    </div>
                </div>

                <!-- VRAM Usage Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">VRAM Usage</h3>
                    <div id="vram-info" class="text-sm text-gray-600">
                        <p class="mb-2">Estimated based on loaded models</p>
                        <div class="mt-4">
                            <div class="flex justify-between text-xs mb-1">
                                <span>Used VRAM</span>
                                <span id="vram-usage">0 GB</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="vram-bar" class="bg-blue-500 h-4 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ComfyUI Status</h3>
                    <div id="comfyui-status" class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">ComfyUI:</span>
                            <span id="comfyui-status-text" class="font-semibold text-gray-400">Checking...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">WAN 2.1:</span>
                            <span id="wan21-status-text" class="font-semibold text-gray-400">Checking...</span>
                        </div>
                        <button onclick="checkComfyUIStatus()"
                                class="w-full bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-2 px-4 rounded transition mt-2">
                            üîÑ Check Status
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loaded Models -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Loaded Models</h3>
                <div id="loaded-models-list" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">No models currently loaded</p>
                </div>
            </div>

            <!-- Available Models -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Available Models</h3>
                <div id="available-models-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Playground Tab -->
        <div id="playground-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Text-to-Image -->
                <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        üé® Text-to-Image Generation
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Panel -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                                <select id="txt2img-model" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="flux">Flux.1-dev (Best Quality)</option>
                                    <option value="sdxl" selected>SDXL (Faster)</option>
                                    <option value="sd3">Stable Diffusion 3</option>
                                    <option value="pony">Pony Diffusion V7 (Stylized)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                                <textarea id="txt2img-prompt" rows="4" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="a beautiful sunset over mountains, digital art, highly detailed"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Negative Prompt</label>
                                <textarea id="txt2img-negative" rows="2" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="blurry, low quality, distorted"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Width</label>
                                    <select id="txt2img-width" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="512">512</option>
                                        <option value="768">768</option>
                                        <option value="1024" selected>1024</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Height</label>
                                    <select id="txt2img-height" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="512">512</option>
                                        <option value="768">768</option>
                                        <option value="1024" selected>1024</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Steps: <span id="txt2img-steps-value">30</span>
                                </label>
                                <input type="range" id="txt2img-steps" min="10" max="50" value="30" 
                                    class="w-full" oninput="document.getElementById('txt2img-steps-value').textContent = this.value">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Guidance Scale: <span id="txt2img-guidance-value">7.5</span>
                                </label>
                                <input type="range" id="txt2img-guidance" min="1" max="20" step="0.5" value="7.5" 
                                    class="w-full" oninput="document.getElementById('txt2img-guidance-value').textContent = this.value">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Seed (optional)</label>
                                <input type="number" id="txt2img-seed" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    placeholder="Random seed or leave empty">
                            </div>
                            
                            <button onclick="generateImage()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition">
                                üé® Generate Image
                            </button>
                        </div>
                        
                        <!-- Preview Panel -->
                        <div>
                            <div class="bg-gray-50 rounded-lg border-2 border-gray-200 preview-container" id="txt2img-preview">
                                <div class="text-center text-gray-400">
                                    <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p>Your generated image will appear here</p>
                                </div>
                            </div>
                            <div id="txt2img-info" class="mt-4 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <!-- Text-to-Video (AnimateDiff Lightning) -->
                <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        üéûÔ∏è Text-to-Video (AnimateDiff Lightning)
                    </h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Panel -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                                <textarea id="txt2vid-prompt" rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="cinematic shot of a futuristic city, dramatic lighting"></textarea>
                                <p class="text-xs text-gray-500 mt-1">Use short, descriptive prompts for best results</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Negative Prompt (optional)</label>
                                <textarea id="txt2vid-negative" rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="low quality, blurry, distorted"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Number of Frames: <span id="txt2vid-frames-value">16</span>
                                </label>
                                <input type="range" id="txt2vid-frames" min="8" max="32" value="16"
                                    class="w-full" oninput="document.getElementById('txt2vid-frames-value').textContent = this.value">
                                <p class="text-xs text-gray-500 mt-1">More frames = longer clips (Lightning defaults: 16-24)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Steps: <span id="txt2vid-steps-value">8</span>
                                </label>
                                <input type="range" id="txt2vid-steps" min="4" max="20" value="8"
                                    class="w-full" oninput="document.getElementById('txt2vid-steps-value').textContent = this.value">
                                <p class="text-xs text-gray-500 mt-1">Lightning works best with 4-8 steps</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Guidance Scale: <span id="txt2vid-guidance-value">1.5</span>
                                </label>
                                <input type="range" id="txt2vid-guidance" min="1" max="3" step="0.1" value="1.5"
                                    class="w-full" oninput="document.getElementById('txt2vid-guidance-value').textContent = this.value">
                                <p class="text-xs text-gray-500 mt-1">Lower guidance keeps motion smooth</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    FPS: <span id="txt2vid-fps-value">8</span>
                                </label>
                                <input type="range" id="txt2vid-fps" min="5" max="30" value="8"
                                    class="w-full" oninput="document.getElementById('txt2vid-fps-value').textContent = this.value">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Resolution</label>
                                    <select id="txt2vid-resolution" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="512">512 x 512</option>
                                        <option value="768">768 x 768</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Seed (optional)</label>
                                    <input type="number" id="txt2vid-seed"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                        placeholder="Leave empty for random seed">
                                </div>
                            </div>

                            <button onclick="generateTextVideo()"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg transition">
                                üéûÔ∏è Generate Video
                            </button>
                        </div>

                        <!-- Preview Panel -->
                        <div>
                            <div class="bg-gray-50 rounded-lg border-2 border-gray-200 preview-container" id="txt2vid-preview">
                                <div class="text-center text-gray-400">
                                    <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-9 4v7"></path>
                                    </svg>
                                    <p>Your generated video preview will appear here</p>
                                </div>
                            </div>
                            <div id="txt2vid-info" class="mt-4 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <!-- Image-to-Text -->
                <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        üîç Image-to-Text (Captioning)
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Panel -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                                <select id="img2txt-model" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="llava">LLaVA 1.6 (Detailed)</option>
                                    <option value="blip">BLIP-2 (Faster)</option>
                                    <option value="qwen">Qwen2-VL 2B (Multimodal)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
                                <input type="file" id="img2txt-upload" accept="image/*" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    onchange="previewImageToText(this)">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prompt (optional)</label>
                                <textarea id="img2txt-prompt" rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Describe this image in detail.">Describe this image in detail.</textarea>
                                <p class="text-xs text-gray-500 mt-1">Helpful for LLaVA and Qwen. BLIP-2 ignores prompts.</p>
                            </div>
                            
                            <button onclick="captionImage()" id="caption-btn" disabled
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                üîç Generate Caption
                            </button>
                            
                            <div id="img2txt-result" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-24">
                                <p class="text-gray-400 text-center">Caption will appear here</p>
                            </div>
                        </div>
                        
                        <!-- Preview Panel -->
                        <div>
                            <div class="bg-gray-50 rounded-lg border-2 border-gray-200 preview-container" id="img2txt-preview">
                                <div class="text-center text-gray-400">
                                    <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p>Upload an image to caption</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image-to-Video -->
                <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        üé¨ Image-to-Video
                    </h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Panel -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                                <select id="img2vid-model" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updateVideoModelParams()">
                                    <option value="svd">Stable Video Diffusion (Standard)</option>
                                    <option value="wan21" id="wan21-option" disabled>WAN 2.1 + LightX2V (ComfyUI Required)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1" id="model-description">
                                    Standard image-to-video with smooth motion
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
                                <input type="file" id="img2vid-upload" accept="image/*" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    onchange="previewImageToVideo(this)">
                                <p class="text-xs text-gray-500 mt-1" id="img2vid-resize-info">
                                    Will be resized to 1024x576 for optimal results
                                </p>
                            </div>

                            <div id="img2vid-prompt-container" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prompt (Optional)</label>
                                <textarea id="img2vid-prompt" rows="2" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="smooth camera movement, high quality"></textarea>
                                <p class="text-xs text-gray-500 mt-1">Guidance for video generation</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Number of Frames: <span id="img2vid-frames-value">14</span>
                                </label>
                                <input type="range" id="img2vid-frames" min="8" max="25" value="14" 
                                    class="w-full" oninput="document.getElementById('img2vid-frames-value').textContent = this.value">
                                <p class="text-xs text-gray-500 mt-1" id="frames-hint">~2 seconds at 7 FPS</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Steps: <span id="img2vid-steps-value">25</span>
                                </label>
                                <input type="range" id="img2vid-steps" min="10" max="50" value="25" 
                                    class="w-full" oninput="document.getElementById('img2vid-steps-value').textContent = this.value">
                            </div>

                            <div id="guidance-container">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Guidance Scale: <span id="img2vid-guidance-value">1.5</span>
                                </label>
                                <input type="range" id="img2vid-guidance" min="1.0" max="3.5" step="0.1" value="1.5" 
                                    class="w-full" oninput="document.getElementById('img2vid-guidance-value').textContent = this.value">
                                <p class="text-xs text-gray-500 mt-1">How closely to follow the prompt</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    FPS: <span id="img2vid-fps-value">7</span>
                                </label>
                                <input type="range" id="img2vid-fps" min="5" max="30" value="7" 
                                    class="w-full" oninput="document.getElementById('img2vid-fps-value').textContent = this.value">
                            </div>

                            <div id="motion-container">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Motion Intensity: <span id="img2vid-motion-value">127</span>
                                </label>
                                <input type="range" id="img2vid-motion" min="1" max="255" value="127" 
                                    class="w-full" oninput="document.getElementById('img2vid-motion-value').textContent = this.value">
                                <p class="text-xs text-gray-500">Higher = more motion (SVD only)</p>
                            </div>

                            <button onclick="generateVideo()" id="video-btn" disabled
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                üé¨ Generate Video
                            </button>

                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800" id="video-warning">
                                ‚ö†Ô∏è Video generation takes 1-2 minutes and uses significant VRAM
                            </div>
                        </div>

                        <!-- Preview Panel -->
                        <div>
                            <div class="bg-gray-50 rounded-lg border-2 border-gray-200 preview-container" id="img2vid-preview">
                                <div class="text-center text-gray-400">
                                    <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    <p>Upload an image to animate</p>
                                </div>
                            </div>
                            <div id="img2vid-info" class="mt-4 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <!-- Talking Head (InfiniteTalk) -->
                <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        üó£Ô∏è Talking Head (InfiniteTalk)
                    </h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Panel -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Face Image</label>
                                <input type="file" id="infinitetalk-face-upload" accept="image/*"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    onchange="previewInfiniteTalkFace(this)">
                                <p class="text-xs text-gray-500 mt-1">Portrait photo with clear face visible</p>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <p class="text-sm font-medium text-blue-900 mb-2">Input Mode:</p>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="infinitetalk-mode" value="audio" checked
                                            class="mr-2" onchange="toggleInfiniteTalkMode()">
                                        <span class="text-sm text-blue-800">üéµ Audio File (provide your own audio)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="infinitetalk-mode" value="text"
                                            class="mr-2" onchange="toggleInfiniteTalkMode()">
                                        <span class="text-sm text-blue-800">üí¨ Text-to-Speech (synthesize speech)</span>
                                    </label>
                                </div>
                            </div>

                            <div id="infinitetalk-audio-input">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Audio File</label>
                                <input type="file" id="infinitetalk-audio-upload" accept="audio/wav,audio/mp3,audio/mpeg"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">WAV or MP3 format, clear speech recommended</p>
                            </div>

                            <div id="infinitetalk-text-input" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Speech Text</label>
                                <textarea id="infinitetalk-text" rows="4"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Enter the text you want the face to speak..."></textarea>
                                <p class="text-xs text-gray-500 mt-1">Will synthesize speech and animate face</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Video Length (frames): <span id="infinitetalk-frames-value">120</span>
                                </label>
                                <input type="range" id="infinitetalk-frames" min="30" max="300" value="120"
                                    class="w-full" oninput="updateInfiniteTalkDuration()">
                                <p class="text-xs text-gray-500 mt-1" id="infinitetalk-duration">~4.8 seconds at 25 FPS</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    FPS: <span id="infinitetalk-fps-value">25</span>
                                </label>
                                <input type="range" id="infinitetalk-fps" min="15" max="30" value="25"
                                    class="w-full" oninput="updateInfiniteTalkDuration()">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Expression Scale: <span id="infinitetalk-expression-value">1.0</span>
                                </label>
                                <input type="range" id="infinitetalk-expression" min="0.5" max="2" step="0.1" value="1.0"
                                    class="w-full"
                                    oninput="document.getElementById('infinitetalk-expression-value').textContent = this.value">
                                <p class="text-xs text-gray-500">Higher = more expressive facial movements</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Head Motion Scale: <span id="infinitetalk-motion-value">1.0</span>
                                </label>
                                <input type="range" id="infinitetalk-motion" min="0.5" max="2" step="0.1" value="1.0"
                                    class="w-full"
                                    oninput="document.getElementById('infinitetalk-motion-value').textContent = this.value">
                                <p class="text-xs text-gray-500">Higher = more head movement</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Seed (optional)</label>
                                <input type="number" id="infinitetalk-seed"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    placeholder="Leave empty for random">
                            </div>

                            <button onclick="generateInfiniteTalk()" id="infinitetalk-btn" disabled
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                üó£Ô∏è Generate Talking Head Video
                            </button>

                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800">
                                ‚ö†Ô∏è Generation takes 1-2 minutes. Ensure face is clearly visible in portrait photo.
                            </div>
                        </div>

                        <!-- Preview Panel -->
                        <div>
                            <div class="bg-gray-50 rounded-lg border-2 border-gray-200 preview-container" id="infinitetalk-preview">
                                <div class="text-center text-gray-400">
                                    <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <p>Upload a face image to begin</p>
                                </div>
                            </div>
                            <div id="infinitetalk-info" class="mt-4 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <!-- ControlNet -->
                <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        üïπÔ∏è ControlNet (SDXL)
                    </h3>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Panel -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                                <select id="controlnet-model" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="mistoline">MistoLine (Line Art)</option>
                                    <option value="union">ControlNet Union SDXL (Universal)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Automatically loads SDXL ControlNet pipelines</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Control Image</label>
                                <input type="file" id="controlnet-upload" accept="image/*"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    onchange="previewControlImage(this)">
                                <p class="text-xs text-gray-500 mt-1">Use sketches or depth maps. Image is auto-resized to match width/height.</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                                <textarea id="controlnet-prompt" rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="highly detailed illustration of a city skyline"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Negative Prompt (optional)</label>
                                <textarea id="controlnet-negative" rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="low quality, distorted"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Control Strength: <span id="controlnet-scale-value">1.0</span>
                                </label>
                                <input type="range" id="controlnet-scale" min="0.1" max="2" step="0.1" value="1.0"
                                    class="w-full" oninput="document.getElementById('controlnet-scale-value').textContent = this.value">
                                <p class="text-xs text-gray-500 mt-1">Lower values = more freedom. Higher values = follow control tightly.</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Steps: <span id="controlnet-steps-value">30</span>
                                    </label>
                                    <input type="range" id="controlnet-steps" min="10" max="60" value="30"
                                        class="w-full" oninput="document.getElementById('controlnet-steps-value').textContent = this.value">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Guidance: <span id="controlnet-guidance-value">7.5</span>
                                    </label>
                                    <input type="range" id="controlnet-guidance" min="1" max="15" step="0.5" value="7.5"
                                        class="w-full" oninput="document.getElementById('controlnet-guidance-value').textContent = this.value">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Width</label>
                                    <select id="controlnet-width" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="768">768</option>
                                        <option value="1024" selected>1024</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Height</label>
                                    <select id="controlnet-height" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="768">768</option>
                                        <option value="1024" selected>1024</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Seed (optional)</label>
                                <input type="number" id="controlnet-seed"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    placeholder="Leave empty for random seed">
                            </div>

                            <button onclick="generateControlImage()" id="controlnet-btn" disabled
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                                üñºÔ∏è Generate Controlled Image
                            </button>
                        </div>

                        <!-- Preview Panel -->
                        <div>
                            <div class="bg-gray-50 rounded-lg border-2 border-gray-200 preview-container" id="controlnet-preview">
                                <div class="text-center text-gray-400">
                                    <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v16h16M4 8h12"></path>
                                    </svg>
                                    <p>Upload a control image and prompt to begin</p>
                                </div>
                            </div>
                            <div id="controlnet-info" class="mt-4 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Results Tab -->
        <div id="results-tab" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-700">Generated Results</h3>
                    <button onclick="refreshResults()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition">
                        üîÑ Refresh
                    </button>
                </div>
                <div id="results-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Metrics Tab -->
        <div id="metrics-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Generation Times Chart -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Generation Times</h3>
                    <canvas id="timesChart"></canvas>
                </div>

                <!-- Requests Per Model Chart -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Requests Per Model</h3>
                    <canvas id="requestsChart"></canvas>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="text-3xl font-bold text-blue-600" id="total-requests">0</div>
                    <div class="text-sm text-gray-600 mt-2">Total Requests</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="text-3xl font-bold text-green-600" id="avg-time">0s</div>
                    <div class="text-sm text-gray-600 mt-2">Avg Generation Time</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="text-3xl font-bold text-purple-600" id="total-images">0</div>
                    <div class="text-sm text-gray-600 mt-2">Images Generated</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="text-3xl font-bold text-orange-600" id="total-videos">0</div>
                    <div class="text-sm text-gray-600 mt-2">Videos Generated</div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs-tab" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700">API Logs</h3>
                    <div class="space-x-2">
                        <button onclick="refreshLogs()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition">
                            üîÑ Refresh
                        </button>
                        <button onclick="clearLogs()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>
                <div id="logs-container" class="bg-gray-900 text-green-400 font-mono text-sm p-4 rounded-lg h-96 overflow-y-auto">
                    <!-- Logs will be populated here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Model Management Settings -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Model Management</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Max Loaded Models
                            </label>
                            <input type="number" id="max-loaded-models" min="1" max="10" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">How many models to keep in memory (requires restart)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Model Timeout (seconds)
                            </label>
                            <input type="number" id="model-timeout" min="60" max="3600" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Time before auto-unloading unused models</p>
                        </div>
                    </div>
                </div>

                <!-- API Configuration -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">API Configuration</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                API Port
                            </label>
                            <input type="number" id="api-port" value="8000" disabled
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                            <p class="text-xs text-gray-500 mt-1">Change in docker-compose.yml</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                CUDA Device
                            </label>
                            <input type="number" id="cuda-device" value="0" disabled
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                            <p class="text-xs text-gray-500 mt-1">GPU device index (requires restart)</p>
                        </div>
                    </div>
                </div>

                <!-- Save Settings -->
                <div class="lg:col-span-2">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-yellow-800">
                            ‚ö†Ô∏è <strong>Note:</strong> Most settings require restarting the Docker container to take effect.
                            Run: <code class="bg-yellow-100 px-2 py-1 rounded">docker-compose restart</code>
                        </p>
                    </div>
                    <button onclick="saveSettings()" class="bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-6 rounded-lg transition">
                        üíæ Save Settings
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-300 py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>AI API Dashboard v1.0 ‚Ä¢ Built for n8n automation workflows</p>
        </div>
    </footer>

    <script>
        // Global state
        let metrics = {
            requests: [],
            generationTimes: [],
            modelCounts: {}
        };
        
        let uploadedImageBase64 = null;
        let uploadedVideoImageBase64 = null;
        let uploadedControlImageBase64 = null;
        let uploadedInfiniteTalkFaceBase64 = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            refreshResults();
            refreshLogs();
            loadSettings();
            initCharts();
            updateVideoModelParams();
            checkComfyUIStatus();
            updateInfiniteTalkDuration();
            toggleInfiniteTalkMode();

            // Auto-refresh every 30 seconds
            setInterval(refreshStatus, 30000);
            setInterval(checkComfyUIStatus, 60000);
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName)) {
                    btn.classList.add('active');
                }
            });
        }

        // Refresh system status
        async function refreshStatus() {
            try {
                const response = await fetch('/api/dashboard/status');
                const data = await response.json();
                
                // Update header
                document.getElementById('status-text').textContent = data.status;
                document.getElementById('gpu-name').textContent = data.gpu_name || 'No GPU';
                
                // Update overview cards
                document.getElementById('api-status').textContent = data.status;
                document.getElementById('gpu-status').textContent = data.gpu_available ? 'Yes' : 'No';
                document.getElementById('loaded-count').textContent = data.loaded_models.length;
                
                // Update VRAM
                updateVRAM(data.model_stats);
                
                // Update loaded models list
                updateLoadedModels(data.loaded_models, data.model_stats);
                
                // Update available models
                updateAvailableModels(data.available_models);
                
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('status-indicator').classList.remove('bg-green-400');
                document.getElementById('status-indicator').classList.add('bg-red-400');
                document.getElementById('status-text').textContent = 'Offline';
            }
        }

        function updateVRAM(modelStats) {
            let totalVRAM = 0;
            for (const model in modelStats) {
                totalVRAM += modelStats[model].vram_estimate_gb;
            }
            
            const maxVRAM = 24; // Adjust based on your GPU
            const percentage = (totalVRAM / maxVRAM) * 100;
            
            document.getElementById('vram-usage').textContent = totalVRAM.toFixed(1) + ' GB';
            document.getElementById('vram-bar').style.width = Math.min(percentage, 100) + '%';
            
            if (percentage > 80) {
                document.getElementById('vram-bar').classList.remove('bg-blue-500');
                document.getElementById('vram-bar').classList.add('bg-red-500');
            } else {
                document.getElementById('vram-bar').classList.remove('bg-red-500');
                document.getElementById('vram-bar').classList.add('bg-blue-500');
            }
        }

        function updateLoadedModels(loadedModels, modelStats) {
            const container = document.getElementById('loaded-models-list');
            
            if (loadedModels.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No models currently loaded</p>';
                return;
            }
            
            container.innerHTML = loadedModels.map(modelKey => {
                const stats = modelStats[modelKey];
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <span class="font-medium text-gray-800">${modelKey}</span>
                            <span class="text-sm text-gray-500 ml-2">
                                (Last used: ${stats.last_used_seconds_ago.toFixed(0)}s ago)
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">${stats.vram_estimate_gb} GB</span>
                            <button onclick="unloadModel('${modelKey}')" 
                                    class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded transition">
                                Unload
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAvailableModels(availableModels) {
            const container = document.getElementById('available-models-list');

            container.innerHTML = Object.entries(availableModels).map(([key, model]) => {
                const statusMap = {
                    'text-to-image': { label: 'Playground Ready', classes: 'bg-green-100 text-green-800' },
                    'image-to-text': { label: 'Playground Ready', classes: 'bg-green-100 text-green-800' },
                    'video-generation': { label: 'Playground Ready', classes: 'bg-green-100 text-green-800' },
                    'controlnet': { label: 'Playground Ready', classes: 'bg-green-100 text-green-800' }
                };
                const status = statusMap[model.type] || { label: 'API Only', classes: 'bg-yellow-100 text-yellow-800' };
                return `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-start justify-between mb-2">
                            <h4 class="font-semibold text-gray-800">${model.name}</h4>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${model.type}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">VRAM: ~${model.vram_gb} GB</p>
                        <p class="text-xs text-gray-500 mb-2">${model.model_id}</p>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500">Category: ${model.category || 'General'}</span>
                            <span class="px-2 py-1 rounded ${status.classes}">${status.label}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Unload models
        async function unloadModel(modelName) {
            try {
                const response = await fetch(`/api/unload/${modelName}`, { method: 'POST' });
                if (response.ok) {
                    refreshStatus();
                    showNotification('Model unloaded successfully', 'success');
                }
            } catch (error) {
                showNotification('Error unloading model', 'error');
            }
        }

        async function unloadAllModels() {
            if (!confirm('Are you sure you want to unload all models?')) return;
            
            try {
                const response = await fetch('/api/unload-all', { method: 'POST' });
                if (response.ok) {
                    refreshStatus();
                    showNotification('All models unloaded', 'success');
                }
            } catch (error) {
                showNotification('Error unloading models', 'error');
            }
        }

        // ==================== PLAYGROUND FUNCTIONS ====================

        // Text-to-Image Generation
        async function generateImage() {
            const preview = document.getElementById('txt2img-preview');
            const info = document.getElementById('txt2img-info');
            
            // Get form values
            const model = document.getElementById('txt2img-model').value;
            const prompt = document.getElementById('txt2img-prompt').value;
            const negativePrompt = document.getElementById('txt2img-negative').value;
            const width = parseInt(document.getElementById('txt2img-width').value);
            const height = parseInt(document.getElementById('txt2img-height').value);
            const steps = parseInt(document.getElementById('txt2img-steps').value);
            const guidance = parseFloat(document.getElementById('txt2img-guidance').value);
            const seed = document.getElementById('txt2img-seed').value;
            
            if (!prompt) {
                showNotification('Please enter a prompt', 'error');
                return;
            }
            
            // Show loading
            preview.innerHTML = '<div class="loading-spinner mx-auto"></div><p class="text-center mt-4 text-gray-600">Generating image...</p>';
            info.innerHTML = '<p class="text-blue-600">‚è≥ Generation in progress...</p>';
            
            try {
                const payload = {
                    prompt: prompt,
                    negative_prompt: negativePrompt,
                    width: width,
                    height: height,
                    num_inference_steps: steps,
                    guidance_scale: guidance
                };
                
                if (seed) {
                    payload.seed = parseInt(seed);
                }
                
                const response = await fetch(`/api/generate/${model}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error('Generation failed');
                }
                
                const data = await response.json();
                
                // Display image
                preview.innerHTML = `
                    <img src="data:image/png;base64,${data.image_base64}" 
                         class="max-w-full h-auto rounded-lg" alt="Generated image">
                `;
                
                info.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>‚úÖ Generated in ${data.generation_time}s</span>
                        <a href="data:image/png;base64,${data.image_base64}" download="generated-${model}.png" 
                           class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                            Download
                        </a>
                    </div>
                `;
                
                showNotification('Image generated successfully!', 'success');
                refreshResults();
                refreshMetrics();
                
            } catch (error) {
                preview.innerHTML = '<div class="text-center text-red-500"><p>‚ùå Generation failed</p></div>';
                info.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                showNotification('Generation failed: ' + error.message, 'error');
            }
        }

        // Image-to-Text Captioning
        function previewImageToText(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImageBase64 = e.target.result;
                    document.getElementById('img2txt-preview').innerHTML = `
                        <img src="${e.target.result}" class="max-w-full h-auto rounded-lg" alt="Uploaded image">
                    `;
                    document.getElementById('caption-btn').disabled = false;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function captionImage() {
            if (!uploadedImageBase64) {
                showNotification('Please upload an image first', 'error');
                return;
            }
            
            const model = document.getElementById('img2txt-model').value;
            const prompt = document.getElementById('img2txt-prompt').value;
            const resultDiv = document.getElementById('img2txt-result');
            
            resultDiv.innerHTML = '<div class="text-center"><div class="loading-spinner mx-auto"></div><p class="mt-2">Generating caption...</p></div>';
            
            try {
                let endpoint;
                if (model === 'llava') {
                    endpoint = '/api/caption/llava';
                } else if (model === 'blip') {
                    endpoint = '/api/caption/blip';
                } else {
                    endpoint = '/api/caption/qwen';
                }
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: uploadedImageBase64,
                        prompt: prompt,
                        max_length: 200
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Caption generation failed');
                }
                
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="space-y-2">
                        <p class="font-medium text-gray-800">Caption:</p>
                        <p class="text-gray-700">${data.caption}</p>
                        <p class="text-sm text-gray-500">Generated in ${data.generation_time}s using ${data.model}</p>
                    </div>
                `;
                
                showNotification('Caption generated successfully!', 'success');
                refreshMetrics();
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600 text-center">‚ùå ${error.message}</p>`;
                showNotification('Caption failed: ' + error.message, 'error');
            }
        }

        // Text-to-Video Generation (AnimateDiff)
        async function generateTextVideo() {
            const preview = document.getElementById('txt2vid-preview');
            const info = document.getElementById('txt2vid-info');

            const prompt = document.getElementById('txt2vid-prompt').value.trim();
            const negativePrompt = document.getElementById('txt2vid-negative').value;
            const frames = parseInt(document.getElementById('txt2vid-frames').value);
            const steps = parseInt(document.getElementById('txt2vid-steps').value);
            const guidance = parseFloat(document.getElementById('txt2vid-guidance').value);
            const fps = parseInt(document.getElementById('txt2vid-fps').value);
            const resolution = parseInt(document.getElementById('txt2vid-resolution').value);
            const seedValue = document.getElementById('txt2vid-seed').value;

            if (!prompt) {
                showNotification('Please enter a prompt', 'error');
                return;
            }

            preview.innerHTML = '<div class="text-center"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Generating video with AnimateDiff Lightning...</p></div>';
            info.innerHTML = '<p class="text-blue-600">‚è≥ Video generation in progress... Please wait...</p>';

            const payload = {
                prompt: prompt,
                negative_prompt: negativePrompt,
                num_frames: frames,
                num_inference_steps: steps,
                guidance_scale: guidance,
                fps: fps,
                width: resolution,
                height: resolution
            };

            if (seedValue) {
                payload.seed = parseInt(seedValue);
            }

            try {
                const response = await fetch('/api/video/animatediff', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Video generation failed');
                }

                const data = await response.json();

                preview.innerHTML = `
                    <div class="text-center">
                        <svg class="w-24 h-24 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-700 mb-4">‚úÖ Video generated successfully with ${data.model}!</p>
                        <a href="${data.video_path.replace('/app/outputs/', '/api/download/')}" download
                           class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                            Download Video
                        </a>
                    </div>
                `;

                let infoText = `
                    <div class="text-sm">
                        <p>‚úÖ Generated in ${data.generation_time}s</p>
                        <p>Frames: ${data.num_frames} at ${data.fps} FPS</p>
                        <p>Resolution: ${resolution}x${resolution}</p>
                        <p>Steps Used: ${steps} ‚Ä¢ Guidance: ${guidance}</p>
                `;

                if (data.note) {
                    infoText += `<p class="mt-2 text-gray-600">${data.note}</p>`;
                }

                infoText += `</div>`;
                info.innerHTML = infoText;

                showNotification('Video generated successfully!', 'success');
                refreshResults();
                refreshMetrics();

            } catch (error) {
                preview.innerHTML = '<div class="text-center text-red-500"><p>‚ùå Video generation failed</p></div>';
                info.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                showNotification('Video generation failed: ' + error.message, 'error');
            }
        }

        // Image-to-Video Generation
        function previewImageToVideo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedVideoImageBase64 = e.target.result;
                    document.getElementById('img2vid-preview').innerHTML = `
                        <img src="${e.target.result}" class="max-w-full h-auto rounded-lg" alt="Uploaded image">
                    `;
                    document.getElementById('video-btn').disabled = false;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Update video model parameters based on selection
        function updateVideoModelParams() {
            const model = document.getElementById('img2vid-model').value;
            const framesInput = document.getElementById('img2vid-frames');
            const framesValue = document.getElementById('img2vid-frames-value');
            const stepsInput = document.getElementById('img2vid-steps');
            const stepsValue = document.getElementById('img2vid-steps-value');
            const fpsInput = document.getElementById('img2vid-fps');
            const fpsValue = document.getElementById('img2vid-fps-value');
            const guidanceInput = document.getElementById('img2vid-guidance');
            const guidanceValue = document.getElementById('img2vid-guidance-value');
            const motionContainer = document.getElementById('motion-container');
            const guidanceContainer = document.getElementById('guidance-container');
            const promptContainer = document.getElementById('img2vid-prompt-container');
            const resizeInfo = document.getElementById('img2vid-resize-info');
            const modelDesc = document.getElementById('model-description');
            const framesHint = document.getElementById('frames-hint');
            const videoWarning = document.getElementById('video-warning');

            if (model === 'wan21') {
                // WAN 2.1 + LightX2V settings
                modelDesc.textContent = 'Ultra-fast image-to-video (4-8 steps optimal)';
                resizeInfo.textContent = 'Will be resized to 832x480 or 480x832 based on orientation';

                // Show prompt and guidance for WAN 2.1
                promptContainer.style.display = 'block';
                guidanceContainer.style.display = 'block';
                motionContainer.style.display = 'none';

                // Update defaults for WAN 2.1
                framesInput.min = 25;
                framesInput.max = 81;
                framesInput.value = 49;
                framesValue.textContent = 49;
                framesHint.textContent = '~2 seconds at 24 FPS';

                stepsInput.min = 4;
                stepsInput.max = 12;
                stepsInput.value = 6;
                stepsValue.textContent = 6;

                fpsInput.min = 16;
                fpsInput.max = 30;
                fpsInput.value = 24;
                fpsValue.textContent = 24;

                guidanceInput.value = 1.5;
                guidanceValue.textContent = 1.5;

                videoWarning.innerHTML = '‚ö° WAN 2.1 style: Ultra-fast generation (30-60 seconds)';
                videoWarning.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800';

            } else {
                // SVD settings
                modelDesc.textContent = 'Standard image-to-video with smooth motion';
                resizeInfo.textContent = 'Will be resized to 1024x576 for optimal results';

                // Show motion, hide prompt and guidance for SVD
                promptContainer.style.display = 'none';
                guidanceContainer.style.display = 'none';
                motionContainer.style.display = 'block';

                // Reset to SVD defaults
                framesInput.min = 8;
                framesInput.max = 25;
                framesInput.value = 14;
                framesValue.textContent = 14;
                framesHint.textContent = '~2 seconds at 7 FPS';

                stepsInput.min = 10;
                stepsInput.max = 50;
                stepsInput.value = 25;
                stepsValue.textContent = 25;

                fpsInput.min = 5;
                fpsInput.max = 30;
                fpsInput.value = 7;
                fpsValue.textContent = 7;

                guidanceInput.value = 1.5;
                guidanceValue.textContent = 1.5;

                videoWarning.innerHTML = '‚ö†Ô∏è Video generation takes 1-2 minutes and uses significant VRAM';
                videoWarning.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800';
            }
        }

        // InfiniteTalk Functions
        function previewInfiniteTalkFace(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedInfiniteTalkFaceBase64 = e.target.result;
                    document.getElementById('infinitetalk-preview').innerHTML = `
                        <img src="${e.target.result}" class="max-w-full h-auto rounded-lg" alt="Face image">
                    `;
                    document.getElementById('infinitetalk-btn').disabled = false;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleInfiniteTalkMode() {
            const mode = document.querySelector('input[name="infinitetalk-mode"]:checked').value;
            const audioInput = document.getElementById('infinitetalk-audio-input');
            const textInput = document.getElementById('infinitetalk-text-input');

            if (mode === 'audio') {
                audioInput.style.display = 'block';
                textInput.style.display = 'none';
            } else {
                audioInput.style.display = 'none';
                textInput.style.display = 'block';
            }
        }

        function updateInfiniteTalkDuration() {
            const frames = parseInt(document.getElementById('infinitetalk-frames').value);
            const fps = parseInt(document.getElementById('infinitetalk-fps').value);
            const duration = (frames / fps).toFixed(1);

            document.getElementById('infinitetalk-frames-value').textContent = frames;
            document.getElementById('infinitetalk-fps-value').textContent = fps;
            document.getElementById('infinitetalk-duration').textContent = `~${duration} seconds at ${fps} FPS`;
        }

        async function generateInfiniteTalk() {
            if (!uploadedInfiniteTalkFaceBase64) {
                showNotification('Please upload a face image first', 'error');
                return;
            }

            const mode = document.querySelector('input[name="infinitetalk-mode"]:checked').value;
            const preview = document.getElementById('infinitetalk-preview');
            const info = document.getElementById('infinitetalk-info');
            const button = document.getElementById('infinitetalk-btn');

            if (mode === 'audio') {
                const audioFile = document.getElementById('infinitetalk-audio-upload').files[0];
                if (!audioFile) {
                    showNotification('Please upload an audio file', 'error');
                    return;
                }
            } else {
                const text = document.getElementById('infinitetalk-text').value.trim();
                if (!text) {
                    showNotification('Please enter speech text', 'error');
                    return;
                }
            }

            button.disabled = true;
            preview.innerHTML = '<div class="text-center"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Generating talking head video...</p></div>';
            info.innerHTML = '<p class="text-blue-600">‚è≥ This may take 1-2 minutes...</p>';

            try {
                const payload = {
                    face_image: uploadedInfiniteTalkFaceBase64,
                    num_frames: parseInt(document.getElementById('infinitetalk-frames').value),
                    fps: parseInt(document.getElementById('infinitetalk-fps').value),
                    expression_scale: parseFloat(document.getElementById('infinitetalk-expression').value),
                    head_motion_scale: parseFloat(document.getElementById('infinitetalk-motion').value),
                };

                const seedValue = document.getElementById('infinitetalk-seed').value;
                if (seedValue) {
                    payload.seed = parseInt(seedValue);
                }

                if (mode === 'audio') {
                    const audioFile = document.getElementById('infinitetalk-audio-upload').files[0];
                    const audioBase64 = await fileToBase64(audioFile);
                    payload.audio = audioBase64;
                } else {
                    payload.text = document.getElementById('infinitetalk-text').value;
                }

                const response = await fetch('/api/talking-head/infinitetalk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error('Talking head generation failed');
                }

                const data = await response.json();

                preview.innerHTML = `
                    <div class="text-center">
                        <svg class="w-24 h-24 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-700 mb-4">‚úÖ Talking head video generated!</p>
                        <a href="${data.video_path.replace('/app/outputs/', '/api/download/')}" download
                           class="inline-block bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition">
                            Download Video
                        </a>
                    </div>
                `;

                info.innerHTML = `
                    <div class="text-sm">
                        <p>‚úÖ Generated in ${data.generation_time}s</p>
                        <p>Frames: ${data.num_frames} at ${data.fps} FPS</p>
                        <p>Input: ${data.input_type}</p>
                        <p>Expression Scale: ${payload.expression_scale} | Motion: ${payload.head_motion_scale}</p>
                    </div>
                `;

                showNotification('Talking head video generated successfully!', 'success');
                refreshResults();
                refreshMetrics();

            } catch (error) {
                preview.innerHTML = '<div class="text-center text-red-500"><p>‚ùå Generation failed</p></div>';
                info.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                showNotification('Generation failed: ' + error.message, 'error');
            } finally {
                button.disabled = false;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function checkComfyUIStatus() {
            try {
                const response = await fetch('/api/comfyui/status');
                const data = await response.json();

                const statusText = document.getElementById('comfyui-status-text');
                const wan21Text = document.getElementById('wan21-status-text');
                const wan21Option = document.getElementById('wan21-option');

                if (data.available) {
                    statusText.textContent = 'Online';
                    statusText.className = 'font-semibold text-green-600';
                    wan21Text.textContent = 'Ready';
                    wan21Text.className = 'font-semibold text-green-600';
                    if (wan21Option) {
                        wan21Option.disabled = false;
                        wan21Option.textContent = 'WAN 2.1 + LightX2V (Ultra Fast) ‚úÖ';
                    }
                } else {
                    statusText.textContent = 'Offline';
                    statusText.className = 'font-semibold text-red-600';
                    wan21Text.textContent = 'Not Available';
                    wan21Text.className = 'font-semibold text-red-600';
                    if (wan21Option) {
                        wan21Option.disabled = true;
                        wan21Option.textContent = 'WAN 2.1 + LightX2V (ComfyUI Offline) ‚ùå';
                    }
                }
            } catch (error) {
                console.error('Error checking ComfyUI status:', error);
            }
        }

        // Updated generateVideo function with model selection
        async function generateVideo() {
            if (!uploadedVideoImageBase64) {
                showNotification('Please upload an image first', 'error');
                return;
            }

            const preview = document.getElementById('img2vid-preview');
            const info = document.getElementById('img2vid-info');
            const model = document.getElementById('img2vid-model').value;

            const numFrames = parseInt(document.getElementById('img2vid-frames').value);
            const steps = parseInt(document.getElementById('img2vid-steps').value);
            const fps = parseInt(document.getElementById('img2vid-fps').value);

            // Show loading
            const modelName = model === 'wan21' ? 'WAN 2.1' : 'SVD';
            const estimatedTime = model === 'wan21' ? '30-60 seconds' : '1-2 minutes';
            preview.innerHTML = `<div class="text-center"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Generating video with ${modelName}... This may take ${estimatedTime}</p></div>`;
            info.innerHTML = '<p class="text-blue-600">‚è≥ Video generation in progress... Please wait...</p>';

            try {
                let endpoint, payload;

                if (model === 'wan21') {
                    // WAN 2.1 endpoint
                    endpoint = '/api/video/wan21';
                    const prompt = document.getElementById('img2vid-prompt').value || 'smooth camera movement, high quality';
                    const guidance = parseFloat(document.getElementById('img2vid-guidance').value);

                    payload = {
                        image: uploadedVideoImageBase64,
                        prompt: prompt,
                        num_frames: numFrames,
                        num_inference_steps: steps,
                        guidance_scale: guidance,
                        fps: fps
                    };
                } else {
                    // SVD endpoint
                    endpoint = '/api/video/svd';
                    const motionBucket = parseInt(document.getElementById('img2vid-motion').value);

                    payload = {
                        image: uploadedVideoImageBase64,
                        num_frames: numFrames,
                        num_inference_steps: steps,
                        fps: fps,
                        motion_bucket_id: motionBucket
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Video generation failed');
                }

                const data = await response.json();

                // Display success message with download
                preview.innerHTML = `
                    <div class="text-center">
                        <svg class="w-24 h-24 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-700 mb-4">‚úÖ Video generated successfully with ${data.model}!</p>
                        <a href="${data.video_path.replace('/app/outputs/', '/api/download/')}" download 
                           class="inline-block bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition">
                            Download Video
                        </a>
                    </div>
                `;

                let infoText = `
                    <div class="text-sm">
                        <p>‚úÖ Generated in ${data.generation_time}s</p>
                        <p>Model: ${data.model}</p>
                        <p>Frames: ${data.num_frames} at ${data.fps} FPS</p>
                `;

                if (data.resolution) {
                    infoText += `<p>Resolution: ${data.resolution}</p>`;
                }

                if (data.note) {
                    infoText += `<p class="mt-2 text-gray-600">${data.note}</p>`;
                }

                infoText += `</div>`;
                info.innerHTML = infoText;

                showNotification('Video generated successfully!', 'success');
                refreshResults();
                refreshMetrics();

            } catch (error) {
                preview.innerHTML = '<div class="text-center text-red-500"><p>‚ùå Video generation failed</p></div>';
                info.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                showNotification('Video generation failed: ' + error.message, 'error');
            }
        }

        // ControlNet Generation
        function previewControlImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedControlImageBase64 = e.target.result;
                    document.getElementById('controlnet-preview').innerHTML = `
                        <img src="${e.target.result}" class="max-w-full h-auto rounded-lg" alt="Control image">
                    `;
                    document.getElementById('controlnet-btn').disabled = false;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function generateControlImage() {
            if (!uploadedControlImageBase64) {
                showNotification('Please upload a control image first', 'error');
                return;
            }

            const prompt = document.getElementById('controlnet-prompt').value.trim();
            if (!prompt) {
                showNotification('Please enter a prompt', 'error');
                return;
            }

            const preview = document.getElementById('controlnet-preview');
            const info = document.getElementById('controlnet-info');
            const button = document.getElementById('controlnet-btn');

            const negativePrompt = document.getElementById('controlnet-negative').value;
            const scale = parseFloat(document.getElementById('controlnet-scale').value);
            const steps = parseInt(document.getElementById('controlnet-steps').value);
            const guidance = parseFloat(document.getElementById('controlnet-guidance').value);
            const width = parseInt(document.getElementById('controlnet-width').value);
            const height = parseInt(document.getElementById('controlnet-height').value);
            const seedValue = document.getElementById('controlnet-seed').value;
            const model = document.getElementById('controlnet-model').value;

            button.disabled = true;
            preview.innerHTML = '<div class="text-center"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Generating image with ControlNet...</p></div>';
            info.innerHTML = '<p class="text-blue-600">‚è≥ ControlNet generation in progress...</p>';

            const payload = {
                prompt: prompt,
                negative_prompt: negativePrompt,
                control_image: uploadedControlImageBase64,
                controlnet_conditioning_scale: scale,
                num_inference_steps: steps,
                guidance_scale: guidance,
                width: width,
                height: height
            };

            if (seedValue) {
                payload.seed = parseInt(seedValue);
            }

            const endpoint = model === 'union' ? '/api/controlnet/union' : '/api/controlnet/mistoline';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('ControlNet generation failed');
                }

                const data = await response.json();

                preview.innerHTML = `
                    <img src="data:image/png;base64,${data.image_base64}" class="max-w-full h-auto rounded-lg" alt="Generated ControlNet image">
                `;

                info.innerHTML = `
                    <div class="text-sm space-y-1">
                        <p>‚úÖ Generated in ${data.generation_time}s</p>
                        <p>Model: ${data.model}</p>
                        <p>Resolution: ${width}x${height}</p>
                        <p>Steps: ${steps} ‚Ä¢ Guidance: ${guidance}</p>
                    </div>
                `;

                showNotification('ControlNet image generated successfully!', 'success');
                refreshResults();
                refreshMetrics();

            } catch (error) {
                preview.innerHTML = '<div class="text-center text-red-500"><p>‚ùå ControlNet generation failed</p></div>';
                info.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                showNotification('ControlNet generation failed: ' + error.message, 'error');
            } finally {
                button.disabled = false;
            }
        }

        // Results
        async function refreshResults() {
            try {
                const response = await fetch('/api/dashboard/results');
                const data = await response.json();
                
                const container = document.getElementById('results-gallery');
                
                if (data.results.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No results yet. Use the Playground to generate some!</div>';
                    return;
                }
                
                container.innerHTML = data.results.map(result => {
                    if (result.type === 'image') {
                        return `
                            <div class="gallery-item bg-white rounded-lg shadow-md overflow-hidden">
                                <img src="${result.thumbnail}" alt="${result.model}" class="w-full h-48 object-cover">
                                <div class="p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-sm font-medium text-gray-700">${result.model}</span>
                                        <span class="text-xs text-gray-500">${result.timestamp}</span>
                                    </div>
                                    <p class="text-xs text-gray-600 truncate">${result.prompt || 'No prompt'}</p>
                                    <a href="${result.path}" download class="mt-2 block text-center bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 rounded transition">
                                        Download
                                    </a>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="gallery-item bg-white rounded-lg shadow-md p-4">
                                <div class="flex items-center justify-center h-48 bg-gray-100 rounded mb-3">
                                    <span class="text-4xl">üé¨</span>
                                </div>
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-sm font-medium text-gray-700">Video</span>
                                    <span class="text-xs text-gray-500">${result.timestamp}</span>
                                </div>
                                <a href="${result.path}" download class="block text-center bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 rounded transition">
                                    Download
                                </a>
                            </div>
                        `;
                    }
                }).join('');
                
            } catch (error) {
                console.error('Error fetching results:', error);
            }
        }

        // Metrics
        function initCharts() {
            // Generation times chart
            const timesCtx = document.getElementById('timesChart').getContext('2d');
            window.timesChart = new Chart(timesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Generation Time (s)',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Requests chart
            const requestsCtx = document.getElementById('requestsChart').getContext('2d');
            window.requestsChart = new Chart(requestsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests',
                        data: [],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(168, 85, 247, 0.7)',
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(251, 146, 60, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
            
            refreshMetrics();
        }

        async function refreshMetrics() {
            try {
                const response = await fetch('/api/dashboard/metrics');
                const data = await response.json();
                
                // Update stats
                document.getElementById('total-requests').textContent = data.total_requests;
                document.getElementById('avg-time').textContent = data.avg_generation_time.toFixed(1) + 's';
                document.getElementById('total-images').textContent = data.total_images;
                document.getElementById('total-videos').textContent = data.total_videos;
                
                // Update charts
                if (window.timesChart && data.recent_times.length > 0) {
                    window.timesChart.data.labels = data.recent_times.map((_, i) => `#${i+1}`);
                    window.timesChart.data.datasets[0].data = data.recent_times;
                    window.timesChart.update();
                }
                
                if (window.requestsChart) {
                    window.requestsChart.data.labels = Object.keys(data.requests_per_model);
                    window.requestsChart.data.datasets[0].data = Object.values(data.requests_per_model);
                    window.requestsChart.update();
                }
                
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }

        // Logs
        async function refreshLogs() {
            try {
                const response = await fetch('/api/dashboard/logs');
                const data = await response.json();
                
                const container = document.getElementById('logs-container');
                container.innerHTML = data.logs.map(log => 
                    `<div class="mb-1"><span class="text-gray-500">[${log.timestamp}]</span> ${log.message}</div>`
                ).join('');
                
                // Auto-scroll to bottom
                container.scrollTop = container.scrollHeight;
                
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        function clearLogs() {
            if (!confirm('Clear all logs?')) return;
            fetch('/api/dashboard/logs/clear', { method: 'POST' })
                .then(() => refreshLogs());
        }

        // Settings
        function loadSettings() {
            fetch('/api/dashboard/settings')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('max-loaded-models').value = data.max_loaded_models;
                    document.getElementById('model-timeout').value = data.model_timeout;
                });
        }

        function saveSettings() {
            const settings = {
                max_loaded_models: parseInt(document.getElementById('max-loaded-models').value),
                model_timeout: parseInt(document.getElementById('model-timeout').value)
            };
            
            fetch('/api/dashboard/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(r => r.json())
            .then(data => {
                showNotification('Settings saved! Restart container for changes to take effect.', 'success');
            })
            .catch(error => {
                showNotification('Error saving settings', 'error');
            });
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
